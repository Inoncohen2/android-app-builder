name: Build Android APK

on:
  repository_dispatch:
    types: [build-app]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Download Icon
        run: |
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-mdpi
          
          curl -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          
          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png

      - name: Update Package Name
        run: |
          PKG="${{ github.event.client_payload.package_name }}"
          sed -i "s/package=\".*\"/package=\"$PKG\"/" android/app/src/main/AndroidManifest.xml
          sed -i "s/namespace \".*\"/namespace \"$PKG\"/" android/app/build.gradle
          sed -i "s/applicationId \".*\"/applicationId \"$PKG\"/" android/app/build.gradle
          sed -i "s/^package .*/package $PKG/" android/app/src/main/kotlin/com/example/app/MainActivity.kt

      - name: Update App Name
        run: |
          NAME="${{ github.event.client_payload.name }}"
          sed -i "s/android:label=\".*\"/android:label=\"$NAME\"/" android/app/src/main/AndroidManifest.xml

      - name: Generate Config
        run: |
          # נקה URL מקווים תחתונים
          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
    
          # ולידציה - ערכי Boolean
          NAV="${{ github.event.client_payload.config.navigation }}"
          PTR="${{ github.event.client_payload.config.pull_to_refresh }}"
          ZOOM="${{ github.event.client_payload.config.enable_zoom }}"
          AWAKE="${{ github.event.client_payload.config.keep_awake }}"
          LINKS="${{ github.event.client_payload.config.open_external_links }}"
    
          # ברירת מחדל אם ריק
          [ -z "$NAV" ] && NAV="true"
          [ -z "$PTR" ] && PTR="true"
          [ -z "$ZOOM" ] && ZOOM="false"
          [ -z "$AWAKE" ] && AWAKE="false"
          [ -z "$LINKS" ] && LINKS="false"
    
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '$CLEAN_URL';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primary_color }}';
            static const String themeMode = '${{ github.event.client_payload.config.theme_mode }}';
            static const bool showNavigation = $NAV;
            static const bool pullToRefresh = $PTR;
            static const String orientation = '${{ github.event.client_payload.config.orientation }}';
           static const bool enableZoom = $ZOOM;
            static const bool keepAwake = $AWAKE;
            static const bool openExternalLinks = $LINKS;
          }
          EOF
    
          echo "=========================================="
          echo "✅ Generated config:"
          echo "=========================================="
          cat lib/app_config.dart
          echo "=========================================="


      - name: Install Dependencies
        run: flutter pub get

      - name: Build APK
        run: |
          if [ "${{ github.event.client_payload.build_format }}" == "aab" ]; then
            flutter build appbundle --release
            BUILD_FILE="build/app/outputs/bundle/release/app-release.aab"
          else
            flutter build apk --release
            BUILD_FILE="build/app/outputs/flutter-apk/app-release.apk"
          fi
          echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_ENV

      - name: Upload to Supabase
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          FORMAT="${{ github.event.client_payload.build_format }}"
          
          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/builds/${APP_ID}.${FORMAT}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$BUILD_FILE"
          
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/builds/${APP_ID}.${FORMAT}"
          
          curl -X PATCH \
            "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${APP_ID}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"status\": \"completed\", \"download_url\": \"${DOWNLOAD_URL}\"}"

      - name: Send Email
        run: |
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/builds/${{ github.event.client_payload.app_id }}.${{ github.event.client_payload.build_format }}"
          
          curl -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d '{
              "from": "App Builder <onboarding@resend.dev>",
              "to": ["${{ github.event.client_payload.notification_email }}"],
              "subject": "✅ האפליקציה שלך \"${{ github.event.client_payload.name }}\" מוכנה!",
              "html": "<div dir=\"rtl\"><h2>האפליקציה שלך מוכנה להורדה!</h2><p><strong>שם:</strong> ${{ github.event.client_payload.name }}</p><p><strong>Package:</strong> ${{ github.event.client_payload.package_name }}</p><p><a href=\"'"${DOWNLOAD_URL}"'\" style=\"background: #2196F3; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; display: inline-block;\">הורד ${{ github.event.client_payload.build_format == 'aab' && 'AAB' || 'APK' }}</a></p></div>"
            }'
