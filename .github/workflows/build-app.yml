name: Build Android APK/AAB

on:
  repository_dispatch:
    types: [build-app]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick optipng

      # ============================================
      # ğŸ” DEBUG - Show received config
      # ============================================
      - name: Debug - Show Config
        run: |
          echo "=========================================="
          echo "ğŸ” CONFIG RECEIVED FROM FRONTEND:"
          echo "=========================================="
          echo "App Name: ${{ github.event.client_payload.name }}"
          echo "Package: ${{ github.event.client_payload.package_name }}"
          echo "Website: ${{ github.event.client_payload.website_url }}"
          echo "Privacy Policy: ${{ github.event.client_payload.privacy_policy_url }}"
          echo "Build Format: ${{ github.event.client_payload.build_format }}"
          echo ""
          echo "ğŸ“± FEATURES:"
          echo "Navigation: ${{ github.event.client_payload.config.navigation }}"
          echo "Pull to Refresh: ${{ github.event.client_payload.config.pull_to_refresh }}"
          echo "Splash Screen: ${{ github.event.client_payload.config.splash_screen }}"
          echo "Enable Zoom: ${{ github.event.client_payload.config.enable_zoom }}"
          echo "Keep Awake: ${{ github.event.client_payload.config.keep_awake }}"
          echo "External Links: ${{ github.event.client_payload.config.open_external_links }}"
          echo ""
          echo "ğŸ¨ APPEARANCE:"
          echo "Primary Color: ${{ github.event.client_payload.config.primary_color }}"
          echo "Theme Mode: ${{ github.event.client_payload.config.theme_mode }}"
          echo "Orientation: ${{ github.event.client_payload.config.orientation }}"
          echo "=========================================="

      # ============================================
      # ğŸ¨ ICONS - With Adaptive Icons support
      # ============================================
      - name: Generate Icons
        run: |
          # Create directories
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-mdpi
          
          # Download icon
          curl -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          
          echo "ğŸ“± Generating regular launcher icons..."
          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          
          echo "ğŸ¯ Generating adaptive icon foregrounds..."
          # Create foreground with transparent border for adaptive icons
          convert /tmp/icon.png -bordercolor transparent -border 30 /tmp/icon_fg.png
          
          convert /tmp/icon_fg.png -resize 432x432 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 324x324 android/app/src/main/res/mipmap-xxhdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 216x216 android/app/src/main/res/mipmap-xhdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 162x162 android/app/src/main/res/mipmap-hdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 108x108 android/app/src/main/res/mipmap-mdpi/ic_launcher_foreground.png
          
          echo "âš¡ Optimizing all icons..."
          find android/app/src/main/res -name "ic_launcher*.png" -exec optipng -o7 {} \;
          
          echo "âœ… Icons generated and optimized!"

      - name: Update Package Name
        run: |
          PKG="${{ github.event.client_payload.package_name }}"
          sed -i "s/package=\".*\"/package=\"$PKG\"/" android/app/src/main/AndroidManifest.xml
          sed -i "s/namespace \".*\"/namespace \"$PKG\"/" android/app/build.gradle
          sed -i "s/applicationId \".*\"/applicationId \"$PKG\"/" android/app/build.gradle
          sed -i "s/^package .*/package $PKG/" android/app/src/main/kotlin/com/example/app/MainActivity.kt

      - name: Update App Name
        run: |
          NAME="${{ github.event.client_payload.name }}"
          sed -i "s/android:label=\".*\"/android:label=\"$NAME\"/" android/app/src/main/AndroidManifest.xml

      # ============================================
      # âœ… FIXED CONFIG GENERATION
      # ============================================
      - name: Generate App Config
        run: |
          echo "ğŸ”§ Generating app_config.dart..."
          
          # Clean URL
          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          
          # Get config values
          NAV="${{ github.event.client_payload.config.navigation }}"
          PTR="${{ github.event.client_payload.config.pull_to_refresh }}"
          SPLASH="${{ github.event.client_payload.config.splash_screen }}"
          ZOOM="${{ github.event.client_payload.config.enable_zoom }}"
          AWAKE="${{ github.event.client_payload.config.keep_awake }}"
          LINKS="${{ github.event.client_payload.config.open_external_links }}"
          
          PRIMARY="${{ github.event.client_payload.config.primary_color }}"
          THEME="${{ github.event.client_payload.config.theme_mode }}"
          ORIENT="${{ github.event.client_payload.config.orientation }}"
          PRIVACY="${{ github.event.client_payload.privacy_policy_url }}"
          
          # Defaults
          [ -z "$NAV" ] && NAV="true"
          [ -z "$PTR" ] && PTR="true"
          [ -z "$SPLASH" ] && SPLASH="false"
          [ -z "$ZOOM" ] && ZOOM="false"
          [ -z "$AWAKE" ] && AWAKE="false"
          [ -z "$LINKS" ] && LINKS="false"
          
          [ -z "$PRIMARY" ] && PRIMARY="#2196F3"
          [ -z "$THEME" ] && THEME="auto"
          [ -z "$ORIENT" ] && ORIENT="auto"
          [ -z "$PRIVACY" ] && PRIVACY=""
          
          # Validate booleans
          for var in NAV PTR SPLASH ZOOM AWAKE LINKS; do
            val="${!var}"
            if [[ "$val" != "true" && "$val" != "false" ]]; then
              echo "âš ï¸  Warning: $var=$val is not boolean, using default"
              case $var in NAV|PTR) eval "$var=true";; *) eval "$var=false";; esac
            fi
          done
          
          # Generate config
          cat > lib/app_config.dart << EOF
          class AppConfig {
            // Identity
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String privacyPolicyUrl = '${PRIVACY}';
            
            // Appearance
            static const String primaryColor = '${PRIMARY}';
            static const String themeMode = '${THEME}';
            static const String orientation = '${ORIENT}';
            
            // Features
            static const bool showNavigation = ${NAV};
            static const bool pullToRefresh = ${PTR};
            static const bool splashScreen = ${SPLASH};
            static const bool enableZoom = ${ZOOM};
            static const bool keepAwake = ${AWAKE};
            static const bool openExternalLinks = ${LINKS};
          }
          EOF
          
          echo "=========================================="
          echo "âœ… Generated app_config.dart:"
          echo "=========================================="
          cat lib/app_config.dart
          echo "=========================================="

      - name: Install Dependencies
        run: flutter pub get

      - name: Build APK/AAB
        run: |
          if [ "${{ github.event.client_payload.build_format }}" == "aab" ]; then
            echo "ğŸ”¨ Building AAB for Google Play..."
            flutter build appbundle --release
            BUILD_FILE="build/app/outputs/bundle/release/app-release.aab"
          else
            echo "ğŸ”¨ Building APK..."
            flutter build apk --release
            BUILD_FILE="build/app/outputs/flutter-apk/app-release.apk"
          fi
          echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_ENV

      - name: Upload to Supabase
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          FORMAT="${{ github.event.client_payload.build_format }}"
          
          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/builds/${APP_ID}.${FORMAT}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$BUILD_FILE"
          
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/builds/${APP_ID}.${FORMAT}"
          
          curl -X PATCH \
            "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${APP_ID}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "{\"status\": \"completed\", \"download_url\": \"${DOWNLOAD_URL}\"}"

      - name: Send Email
        run: |
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/builds/${{ github.event.client_payload.app_id }}.${{ github.event.client_payload.build_format }}"
          PRIMARY_COLOR="${{ github.event.client_payload.config.primary_color }}"
          [ -z "$PRIMARY_COLOR" ] && PRIMARY_COLOR="#2196F3"
          ICON_URL="${{ github.event.client_payload.icon_url }}"
          
          # Build features badges
          FEATURES=""
          if [ "${{ github.event.client_payload.config.navigation }}" = "true" ]; then
            FEATURES="${FEATURES}<span style='display:inline-block;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;margin:4px;'>ğŸ§­ Navigation</span>"
          fi
          if [ "${{ github.event.client_payload.config.pull_to_refresh }}" = "true" ]; then
            FEATURES="${FEATURES}<span style='display:inline-block;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;margin:4px;'>ğŸ”„ Refresh</span>"
          fi
          if [ "${{ github.event.client_payload.config.enable_zoom }}" = "true" ]; then
            FEATURES="${FEATURES}<span style='display:inline-block;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;margin:4px;'>ğŸ” Zoom</span>"
          fi
          
          EMAIL_HTML="<!DOCTYPE html><html dir='rtl'><head><meta charset='UTF-8'></head><body style='margin:0;padding:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);'><div style='max-width:650px;margin:40px auto;padding:0 20px;'><div style='text-align:center;margin-bottom:24px;'><img src='https://res.cloudinary.com/ddsogd7hv/image/upload/v1770576910/Icon2_dvenip.png' style='width:80px;height:80px;border-radius:20px;box-shadow:0 8px 24px rgba(0,0,0,0.2);'/><div style='margin-top:12px;'><a href='https://web2app-builder.vercel.app/' style='color:white;text-decoration:none;font-size:24px;font-weight:700;'>Web2App Builder</a></div></div><div style='background:white;border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);'><div style='background:${PRIMARY_COLOR};padding:48px 32px;text-align:center;'><div style='font-size:64px;margin-bottom:16px;'>âœ…</div><h1 style='margin:0;color:white;font-size:28px;'>×”××¤×œ×™×§×¦×™×” ×©×œ×š ××•×›× ×”! ğŸ‰</h1><p style='margin:16px 0 0;color:rgba(255,255,255,0.95);'>×”×‘× ×™×™×” ×”×•×©×œ××” ×‘×”×¦×œ×—×”</p></div><div style='padding:40px 32px;'><div style='text-align:center;margin-bottom:32px;'><img src='${ICON_URL}' style='width:100px;height:100px;border-radius:24px;box-shadow:0 8px 24px rgba(0,0,0,0.15);margin-bottom:16px;'/><h2 style='margin:0;color:#1a1a1a;font-size:24px;'>${{ github.event.client_payload.name }}</h2><p style='margin:8px 0 0;color:#666;font-size:14px;'>${{ github.event.client_payload.package_name }}</p></div><div style='text-align:center;margin:40px 0;'><a href='${DOWNLOAD_URL}' style='display:inline-block;background:${PRIMARY_COLOR};color:white;text-decoration:none;padding:18px 56px;border-radius:50px;font-size:18px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,0.2);'>â¬‡ï¸ ×”×•×¨×“ ${{ github.event.client_payload.build_format == 'aab' && 'AAB' || 'APK' }}</a></div><div style='background:#ffeef8;padding:24px;border-radius:16px;margin:24px 0;'><h3 style='margin:0 0 16px;color:#1a1a1a;font-size:18px;'>âœ¨ ×¤×™×¦'×¨×™×</h3><div style='text-align:center;'>${FEATURES}</div></div></div></div></div></body></html>"
          
          EMAIL_HTML_ESCAPED=$(echo "$EMAIL_HTML" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\n')
          
          curl -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d "{\"from\":\"Web2App Builder <onboarding@resend.dev>\",\"to\":[\"${{ github.event.client_payload.notification_email }}\"],\"subject\":\"ğŸ‰ ×”××¤×œ×™×§×¦×™×” \\\"${{ github.event.client_payload.name }}\\\" ×©×œ×š ××•×›× ×”!\",\"html\":\"${EMAIL_HTML_ESCAPED}\"}"
