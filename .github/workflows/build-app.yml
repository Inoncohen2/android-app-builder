name: Build Android APK

on:
  repository_dispatch:
    types: [build-app]

jobs:
  # ============================================
  # âš¡ ×’'×•×‘ 1: ×”×›× ×” ××”×™×¨×” ×•×¢×™×‘×•×“ ×’×¨×¤×™
  # ============================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      app_name_clean: ${{ steps.prep_step.outputs.app_name_clean }}
    steps:
      - name: Initial Notification
        run: |
          # ×ª×™×§×•×Ÿ: ×©×™× ×•×™ ×-app_id ×œ-id ×‘×”×ª×× ×œ×¡×›××” ×”×—×“×©×”
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"apk_status\": \"building\", \"apk_progress\": 1, \"apk_message\": \"Connecting to build server...\"}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Graphic Tools
        run: sudo apt-get update && sudo apt-get install -y imagemagick optipng pngquant zip

      - name: Process Assets & Config
        id: prep_step
        run: |
          # ×“×™×•×•×— ×”×ª×§×“××•×ª ×œ×¢××•×“×•×ª APK
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"apk_progress\": 10, \"apk_message\": \"Generating adaptive icons...\"}"

          mkdir -p android/app/src/main/res/mipmap-xxxhdpi android/app/src/main/res/values
          curl -s -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          
          # ×”×ª×××ª ××¤×ª×— ×¦×‘×¢ ××”×§×•× ×¤×™×’
          PRIMARY_COLOR="${{ github.event.client_payload.config.primaryColor }}"
          [ -z "$PRIMARY_COLOR" ] && PRIMARY_COLOR="#FFFFFF"
          echo "<?xml version='1.0' encoding='utf-8'?><resources><color name='ic_launcher_background'>$PRIMARY_COLOR</color></resources>" > android/app/src/main/res/values/ic_launcher_background.xml

          convert /tmp/icon.png -bordercolor transparent -border 30% /tmp/icon_fg.png
          
          mkdir -p android/app/src/main/res/mipmap-mdpi android/app/src/main/res/mipmap-hdpi android/app/src/main/res/mipmap-xhdpi android/app/src/main/res/mipmap-xxhdpi android/app/src/main/res/mipmap-xxxhdpi
          convert /tmp/icon_fg.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher_foreground.png
          convert /tmp/icon_fg.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_foreground.png

          mkdir -p android/app/src/main/res/mipmap-anydpi-v26
          echo '<?xml version="1.0" encoding="utf-8"?><adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android"><background android:drawable="@color/ic_launcher_background"/><foreground android:drawable="@mipmap/ic_launcher_foreground"/></adaptive-icon>' > android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
          cp android/app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml android/app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png

          find android/app/src/main/res -name "*.png" -exec optipng -o7 -quiet {} \;

          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          
          # ×”×–×¨×§×ª ×§×•× ×¤×™×’×•×¨×¦×™×” ×¢× ×”××¤×ª×—×•×ª ×”× ×›×•× ×™× ××”-JSON
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primaryColor }}';
            static const String themeMode = '${{ github.event.client_payload.config.themeMode }}';
            static const String orientation = '${{ github.event.client_payload.config.orientation }}';
            static const bool showNavigation = ${{ github.event.client_payload.config.showNavBar }};
            static const bool pullToRefresh = ${{ github.event.client_payload.config.enablePullToRefresh }};
            static const bool splashScreen = ${{ github.event.client_payload.config.showSplashScreen }};
            static const bool enableZoom = ${{ github.event.client_payload.config.enableZoom }};
            static const bool keepAwake = ${{ github.event.client_payload.config.keepAwake }};
            static const bool openExternalLinks = ${{ github.event.client_payload.config.openExternalLinks }};
            static const String privacyPolicyUrl = '${{ github.event.client_payload.config.privacyPolicyUrl }}';
            static const String termsUrl = '${{ github.event.client_payload.config.termsOfServiceUrl }}';
          }
          EOF

          cat > lib/settings_screen.dart << 'DART_EOF'
          import 'package:flutter/material.dart';
          import 'package:url_launcher/url_launcher.dart';
          import 'app_config.dart';
          class SettingsScreen extends StatelessWidget {
            const SettingsScreen({Key? key}) : super(key: key);
            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(title: const Text('Settings')),
                body: ListView(
                  children: [
                    const SizedBox(height: 20),
                    ListTile(leading: const Icon(Icons.info), title: Text(AppConfig.appName), subtitle: const Text('Version 1.0.0')),
                    const Divider(),
                    if (AppConfig.privacyPolicyUrl.isNotEmpty) ListTile(leading: const Icon(Icons.privacy_tip), title: const Text('Privacy Policy'), onTap: () => launchUrl(Uri.parse(AppConfig.privacyPolicyUrl))),
                    if (AppConfig.termsUrl.isNotEmpty) ListTile(leading: const Icon(Icons.description), title: const Text('Terms'), onTap: () => launchUrl(Uri.parse(AppConfig.termsUrl))),
                  ],
                ),
              );
            }
          }
          DART_EOF

          echo "app_name_clean=$(echo '${{ github.event.client_payload.name }}' | tr ' ' '_')" >> $GITHUB_OUTPUT
          
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"apk_progress\": 35, \"apk_message\": \"Assets & Settings ready...\"}"

      - name: Upload Prepared Files
        uses: actions/upload-artifact@v4
        with:
          name: prep-files
          path: |
            android/app/src/main/res/
            lib/app_config.dart
            lib/settings_screen.dart

  # ============================================
  # ğŸ—ï¸ ×’'×•×‘ 2: ×”×‘× ×™×™×”
  # ============================================
  build:
    needs: prepare
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/cirruslabs/flutter:3.19.0
    
    env:
      SUPA_URL: ${{ secrets.SUPABASE_URL }}
      SUPA_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      APP_ID: ${{ github.event.client_payload.app_id }}

    steps:
      - name: Fix Git Permissions
        run: git config --global --add safe.directory '*'

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Prepared Files
        uses: actions/download-artifact@v4
        with:
          name: prep-files

      - name: Mega Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.pub-cache
            build/
          key: ${{ runner.os }}-mega-v10-${{ hashFiles('**/*.gradle*', 'pubspec.lock') }}
          restore-keys: ${{ runner.os }}-mega-v10-

      - name: Create Progress Helper
        run: |
          cat << 'EOF' > update_progress.sh
          #!/bin/sh
          curl -s -X PATCH "$SUPA_URL/rest/v1/apps?id=eq.$APP_ID" \
            -H "apikey: $SUPA_KEY" -H "Authorization: Bearer $SUPA_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"apk_progress\": $1, \"apk_message\": \"$2\"}" > /dev/null
          EOF
          chmod +x update_progress.sh

      - name: Pre-warm & Build
        run: |
          ./update_progress.sh 40 "Warming up build engine..."
          flutter precache --android --no-universal
          
          (
            for i in $(seq 45 90); do
              sleep 5
              if [ $i -lt 65 ]; then MSG="Compiling Dart code ($i%)...";
              elif [ $i -lt 80 ]; then MSG="Building native components ($i%)...";
              else MSG="Assembling final package ($i%)..."; fi
              ./update_progress.sh $i "$MSG"
            done
          ) &
          BG_PID=$!

          flutter pub get
          if [ "${{ github.event.client_payload.build_format }}" = "aab" ]; then
            flutter build appbundle --release --no-pub
            echo "BUILD_FILE=build/app/outputs/bundle/release/app-release.aab" >> $GITHUB_ENV
          else
            flutter build apk --release --no-pub
            echo "BUILD_FILE=build/app/outputs/flutter-apk/app-release.apk" >> $GITHUB_ENV
          fi

          kill $BG_PID 2>/dev/null || true
          ./update_progress.sh 92 "Compilation finished!"

      - name: Upload Binary
        run: |
          ./update_progress.sh 95 "Uploading binary..."
          FORMAT="${{ github.event.client_payload.build_format }}"
          APP_NAME="${{ needs.prepare.outputs.app_name_clean }}"
          
          curl -s -X POST "$SUPA_URL/storage/v1/object/builds/${APP_ID}.${FORMAT}" \
            -H "Authorization: Bearer $SUPA_KEY" -H "x-upsert: true" -H "Content-Type: application/octet-stream" \
            --data-binary @"$BUILD_FILE"
          
          DOWNLOAD_URL="$SUPA_URL/storage/v1/object/public/builds/${APP_ID}.${FORMAT}?download=${APP_NAME}.${FORMAT}"
          
          curl -s -X PATCH "$SUPA_URL/rest/v1/apps?id=eq.${APP_ID}" \
            -H "apikey: $SUPA_KEY" -H "Authorization: Bearer $SUPA_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"apk_status\": \"completed\", \"apk_progress\": 100, \"apk_message\": \"Done!\", \"download_url\": \"${DOWNLOAD_URL}\"}"

      - name: Send Beautiful Email
        run: |
          APP_NAME_CLEAN=$(echo "${{ github.event.client_payload.name }}" | tr ' ' '_')
          DOWNLOAD_URL="$SUPA_URL/storage/v1/object/public/builds/${APP_ID}.${{ github.event.client_payload.build_format }}?download=${APP_NAME_CLEAN}.${{ github.event.client_payload.build_format }}"
          EMAIL_HTML="<!DOCTYPE html><html dir='rtl'><body style='font-family:Arial;background:#f0f2f5;text-align:center;padding:40px;'><div style='background:white;border-radius:20px;padding:40px;max-width:600px;margin:0 auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);'><h1 style='color:#2196F3;'>×”××¤×œ×™×§×¦×™×” ×©×œ×š ××•×›× ×”! ğŸ‰</h1><p style='font-size:18px;'>×”×‘× ×™×™×” ×©×œ <b>${{ github.event.client_payload.name }}</b> ×”×¡×ª×™×™××” ×‘×”×¦×œ×—×”.</p><br><a href='$DOWNLOAD_URL' style='background:#2196F3;color:white;padding:15px 30px;text-decoration:none;border-radius:50px;font-weight:bold;font-size:18px;'>×”×•×¨×“ ${{ github.event.client_payload.build_format }}</a><br><br><p style='color:#666;font-size:12px;'>× ×‘× ×” ×‘×××¦×¢×•×ª Web2App Builder</p></div></body></html>"
          EMAIL_HTML_ESCAPED=$(echo "$EMAIL_HTML" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\n')
          curl -s -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d "{\"from\":\"Web2App <onboarding@resend.dev>\",\"to\":[\"${{ github.event.client_payload.notification_email }}\"],\"subject\":\"ğŸ‰ ×”××¤×œ×™×§×¦×™×” ××•×›× ×”!\",\"html\":\"${EMAIL_HTML_ESCAPED}\"}"
