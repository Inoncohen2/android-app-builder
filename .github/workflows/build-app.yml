name: Build Android APK

on:
  repository_dispatch:
    types: [build-app]

jobs:
  # ============================================
  # âš¡ ×’'×•×‘ 1: ×”×–× ×§×” ××”×™×¨×” (Instant Start)
  # ============================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      app_name_clean: ${{ steps.prep_step.outputs.app_name_clean }}
    steps:
      - name: Initial Notification
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"progress\": 1, \"build_message\": \"Connecting to build server...\"}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Graphic Tools
        run: |
          sudo apt-get update > /dev/null 2>&1
          sudo apt-get install -y imagemagick > /dev/null 2>&1

      - name: Process Assets & Config
        id: prep_step
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"progress\": 10, \"build_message\": \"Processing app assets and icons...\"}"

          mkdir -p android/app/src/main/res/mipmap-mdpi android/app/src/main/res/mipmap-hdpi android/app/src/main/res/mipmap-xhdpi android/app/src/main/res/mipmap-xxhdpi android/app/src/main/res/mipmap-xxxhdpi
          
          curl -s -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png

          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primary_color }}';
            static const String themeMode = '${{ github.event.client_payload.config.theme_mode }}';
            static const String orientation = '${{ github.event.client_payload.config.orientation }}';
            static const bool showNavigation = ${{ github.event.client_payload.config.navigation }};
            static const bool pullToRefresh = ${{ github.event.client_payload.config.pull_to_refresh }};
            static const bool splashScreen = ${{ github.event.client_payload.config.splash_screen }};
            static const bool enableZoom = ${{ github.event.client_payload.config.enable_zoom }};
            static const bool keepAwake = ${{ github.event.client_payload.config.keep_awake }};
            static const bool openExternalLinks = ${{ github.event.client_payload.config.open_external_links }};
            static const String privacyPolicyUrl = '${{ github.event.client_payload.config.privacy_policy_url }}';
            static const String termsUrl = '${{ github.event.client_payload.config.terms_url }}';
          }
          EOF

          echo "app_name_clean=$(echo '${{ github.event.client_payload.name }}' | tr ' ' '_')" >> $GITHUB_OUTPUT
          
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"progress\": 35, \"build_message\": \"Assets ready, launching build engine...\"}"

      - name: Upload Prepared Files
        uses: actions/upload-artifact@v4
        with:
          name: prep-files
          path: |
            android/app/src/main/res/
            lib/app_config.dart

  # ============================================
  # ğŸ—ï¸ ×’'×•×‘ 2: ×”×‘× ×™×™×” (×”×—×œ×§ ×”×›×‘×“)
  # ============================================
  build:
    needs: prepare
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/cirruslabs/flutter:3.19.0
    
    env:
      SUPA_URL: ${{ secrets.SUPABASE_URL }}
      SUPA_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      APP_ID: ${{ github.event.client_payload.app_id }}

    steps:
      - name: Fix Git Permissions
        run: git config --global --add safe.directory '*'

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Prepared Files
        uses: actions/download-artifact@v4
        with:
          name: prep-files

      - name: Mega Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/android-build-cache
            ~/.pub-cache
            /opt/android-sdk-linux/platforms
            /opt/android-sdk-linux/build-tools
            build/
          key: ${{ runner.os }}-mega-v10-${{ hashFiles('**/*.gradle*', 'pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-mega-v10-

      - name: Create Progress Helper
        run: |
          cat << 'EOF' > update_progress.sh
          #!/bin/sh
          curl -s -X PATCH "$SUPA_URL/rest/v1/apps?app_id=eq.$APP_ID" \
            -H "apikey: $SUPA_KEY" \
            -H "Authorization: Bearer $SUPA_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"progress\": $1, \"build_message\": \"$2\"}" > /dev/null
          EOF
          chmod +x update_progress.sh

      - name: Pre-warm SDK & Dependencies
        run: |
          ./update_progress.sh 45 "Warming up Android environment..."
          flutter precache --android --no-universal
          yes | sdkmanager --licenses > /dev/null 2>&1 || true

      - name: Build Application
        run: |
          (
            i=50
            while [ $i -le 90 ]; do
              if [ $i -lt 65 ]; then MSG="Compiling Dart code ($i%)...";
              elif [ $i -lt 80 ]; then MSG="Building native components ($i%)...";
              else MSG="Assembling final package ($i%)..."; fi
              ./update_progress.sh $i "$MSG"
              sleep 6
              i=$((i + 1))
            done
          ) &
          BG_PID=$!

          mkdir -p ~/.gradle
          echo "org.gradle.caching=true" > ~/.gradle/gradle.properties
          echo "org.gradle.parallel=true" >> ~/.gradle/gradle.properties
          echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g" >> ~/.gradle/gradle.properties

          flutter pub get
          
          if [ "${{ github.event.client_payload.build_format }}" = "aab" ]; then
            flutter build appbundle --release --no-pub
            BUILD_FILE="build/app/outputs/bundle/release/app-release.aab"
          else
            flutter build apk --release --no-pub
            BUILD_FILE="build/app/outputs/flutter-apk/app-release.apk"
          fi
          
          kill $BG_PID 2>/dev/null || true
          echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_ENV
          ./update_progress.sh 91 "Application compiled successfully!"

      - name: Cache Cleanup
        if: always()
        run: |
          [ -d ~/.gradle/caches ] && find ~/.gradle/caches -name "*.lock" -type f -delete 2>/dev/null || true

      - name: Upload Binary & Complete
        run: |
          ./update_progress.sh 95 "Uploading to secure storage..."
          FORMAT="${{ github.event.client_payload.build_format }}"
          APP_NAME="${{ needs.prepare.outputs.app_name_clean }}"
          
          curl -s -X POST "$SUPA_URL/storage/v1/object/builds/${APP_ID}.${FORMAT}" \
            -H "Authorization: Bearer $SUPA_KEY" \
            -H "x-upsert: true" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$BUILD_FILE"
          
          DOWNLOAD_URL="$SUPA_URL/storage/v1/object/public/builds/${APP_ID}.${FORMAT}?download=${APP_NAME}.${FORMAT}"
          
          curl -s -X PATCH "$SUPA_URL/rest/v1/apps?app_id=eq.${APP_ID}" \
            -H "apikey: $SUPA_KEY" -H "Authorization: Bearer $SUPA_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"completed\", \"progress\": 100, \"build_message\": \"Build completed!\", \"download_url\": \"${DOWNLOAD_URL}\"}"

      - name: Send Email Notification
        run: |
          APP_NAME="${{ needs.prepare.outputs.app_name_clean }}"
          FORMAT="${{ github.event.client_payload.build_format }}"
          DOWNLOAD_URL="$SUPA_URL/storage/v1/object/public/builds/${APP_ID}.${FORMAT}?download=${APP_NAME}.${FORMAT}"
          curl -s -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d "{\"from\":\"Web2App Builder <onboarding@resend.dev>\",\"to\":[\"${{ github.event.client_payload.notification_email }}\"],\"subject\":\"ğŸ‰ ×”××¤×œ×™×§×¦×™×” ×©×œ×š ××•×›× ×”!\",\"html\":\"<html><body dir='rtl'><h2>×”××¤×œ×™×§×¦×™×” ×©×œ×š ××•×›× ×”!</h2><p>×”×‘× ×™×™×” ×©×œ <b>${{ github.event.client_payload.name }}</b> ×”×¡×ª×™×™××”.</p><a href='$DOWNLOAD_URL'>×œ×—×¥ ×›××Ÿ ×œ×”×•×¨×“×”</a></body></html>\"}"
