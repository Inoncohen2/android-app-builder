name: Package iOS Source Code

on:
  repository_dispatch:
    types: [package-ios-source]

jobs:
  package:
    runs-on: ubuntu-latest # 砖专转 拽住 专  专转 ZIP
    steps:
      - name: Initial Notification
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"ios_source_progress\": 10, \"ios_status\": \"processing\", \"build_message\": \"Preparing iOS source package...\"}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Config & README
        run: |
          # 专拽转 拽驻专爪 注转 -iOS
          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primary_color }}';
            static const String themeMode = '${{ github.event.client_payload.config.theme_mode }}';
            static const String orientation = '${{ github.event.client_payload.config.orientation }}';
            static const bool showNavigation = ${{ github.event.client_payload.config.navigation }};
            static const bool pullToRefresh = ${{ github.event.client_payload.config.pull_to_refresh }};
            static const bool splashScreen = ${{ github.event.client_payload.config.splash_screen }};
            static const bool enableZoom = ${{ github.event.client_payload.config.enable_zoom }};
            static const bool keepAwake = ${{ github.event.client_payload.config.keep_awake }};
            static const bool openExternalLinks = ${{ github.event.client_payload.config.open_external_links }};
          }
          EOF

          # 爪专转 专转 转 -iOS
          cat > README_iOS.txt << EOF
           Your iOS Flutter Project is ready!

          To run this project:
          1. Extract this ZIP.
          2. Open a terminal in the project folder and run:
             flutter pub get
          3. Navigate to the ios folder:
             cd ios
          4. Install CocoaPods:
             pod install
          5. Open 'Runner.xcworkspace' in Xcode and press Run.
          EOF

      - name: Zip Clean iOS Source
        run: |
          # 住 拽驻: 拽  抓 专,  专转 砖转
          zip -r ios_source.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "android/*" \
            -x "build/*" \
            -x ".dart_tool/*" \
            -x ".idea/*" \
            -x "**/*.iml"

      - name: Upload to Supabase Storage
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          curl -s -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/source-code/ios_${APP_ID}.zip" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "x-upsert: true" \
            -H "Content-Type: application/zip" \
            --data-binary @ios_source.zip
          
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/source-code/ios_${APP_ID}.zip"
          
          # 注 砖转 砖 -Supabase
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${APP_ID}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"ios_source_progress\": 100, \"ios_status\": \"completed\", \"ios_source_url\": \"${DOWNLOAD_URL}\"}"
