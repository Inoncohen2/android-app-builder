name: Package Android Source Code

on:
  repository_dispatch:
    types: [package-source]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      # ==========================================
      # 1. ×”×ª×—×œ×” ××”×™×¨×” ×•×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
      # ==========================================
      - name: 5% - Initial Notification
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_status\": \"processing\", \"source_progress\": 5, \"build_message\": \"Initializing source packager...\"}"

      - name: Checkout
        uses: actions/checkout@v4

      # ==========================================
      # 2. ×”×ª×§× ×ª ×›×œ×™× ×•×¢×™×‘×•×“ × ×›×¡×™×
      # ==========================================
      - name: 30% - Install Tools & Prepare Assets
        run: |
          sudo apt-get update > /dev/null && sudo apt-get install -y imagemagick zip > /dev/null
          
          # ×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 30, \"build_message\": \"Processing icons and assets...\"}"

          # ×™×¦×™×¨×ª ×ª×™×§×™×•×ª ×œ××™×™×§×•× ×™×
          mkdir -p android/app/src/main/res/mipmap-mdpi android/app/src/main/res/mipmap-hdpi android/app/src/main/res/mipmap-xhdpi android/app/src/main/res/mipmap-xxhdpi android/app/src/main/res/mipmap-xxxhdpi
          
          # ×”×•×¨×“×” ×•×¢×™×‘×•×“ ×”××™×™×§×•×Ÿ
          curl -s -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png

      # ==========================================
      # 3. ×”×–×¨×§×ª ×§×•× ×¤×™×’×•×¨×¦×™×”
      # ==========================================
      - name: 60% - Inject Configuration
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 60, \"build_message\": \"Writing configuration files...\"}"
          
          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          
          # ×™×¦×™×¨×ª ×§×•×‘×¥ ×”×”×’×“×¨×•×ª ×‘-Dart
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primary_color }}';
            static const String themeMode = '${{ github.event.client_payload.config.theme_mode }}';
            static const String orientation = '${{ github.event.client_payload.config.orientation }}';
            static const bool showNavigation = ${{ github.event.client_payload.config.navigation }};
            static const bool pullToRefresh = ${{ github.event.client_payload.config.pull_to_refresh }};
            static const bool splashScreen = ${{ github.event.client_payload.config.splash_screen }};
            static const bool enableZoom = ${{ github.event.client_payload.config.enable_zoom }};
            static const bool keepAwake = ${{ github.event.client_payload.config.keep_awake }};
            static const bool openExternalLinks = ${{ github.event.client_payload.config.open_external_links }};
            static const String privacyPolicyUrl = '${{ github.event.client_payload.config.privacy_policy_url }}';
            static const String termsUrl = '${{ github.event.client_payload.config.terms_url }}';
          }
          EOF
          
          # ×™×¦×™×¨×ª ×§×•×‘×¥ README ××§×¦×•×¢×™
          cat > README_FIRST.txt << EOF
          # Android Source Code - ${{ github.event.client_payload.name }}

          Generated by Web2App Builder.

          ## How to run:
          1. Install Flutter SDK (https://docs.flutter.dev/get-started/install)
          2. Open this folder in VS Code or Android Studio.
          3. Run 'flutter pub get' in the terminal.
          4. Connect a device or emulator and run 'flutter run'.

          Your configuration is located in: lib/app_config.dart
          EOF

          # ×™×¦×™×¨×ª .gitignore ×¡×˜× ×“×¨×˜×™
          cat > .gitignore << EOF
          .dart_tool/
          .packages
          .pub-cache/
          .pub/
          build/
          .idea/
          .vscode/
          *.iml
          android/.gradle
          android/local.properties
          EOF

      # ==========================================
      # 4. ×›×™×•×•×¥ (ZIP)
      # ==========================================
      - name: 80% - Zip Source
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 80, \"build_message\": \"Compressing source code...\"}"
          
          # ×¡×™× ×•×Ÿ ×§×‘×¦×™× ××™×•×ª×¨×™× ×œ×©××™×¨×” ×¢×œ ZIP ×§×˜×Ÿ ×•× ×§×™
          zip -r source_code.zip . -x ".git/*" ".github/*" "build/*" ".dart_tool/*" ".idea/*" "**/*.iml" "android/.gradle/*"

      # ==========================================
      # 5. ×”×¢×œ××” ×•×¡×™×•×
      # ==========================================
      - name: 95% - Upload to Storage
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          
          curl -s -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/source-code/${APP_ID}.zip" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "x-upsert: true" \
            -H "Content-Type: application/zip" \
            --data-binary @source_code.zip

      - name: 100% - Update DB & Email
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          APP_NAME="${{ github.event.client_payload.name }}"
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/source-code/${APP_ID}.zip"
          
          # ×¢×“×›×•×Ÿ ××¡×“ × ×ª×•× ×™× (×©×“×•×ª Source ×‘×œ×‘×“!)
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${APP_ID}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_status\": \"completed\", \"source_progress\": 100, \"source_url\": \"${DOWNLOAD_URL}\", \"build_message\": \"Source code ready!\"}"

          # ×©×œ×™×—×ª ××™××™×™×œ ××¢×•×¦×‘
          EMAIL_HTML="<!DOCTYPE html><html dir='rtl'><body style='font-family:Arial;background:#f0f2f5;text-align:center;padding:40px;'><div style='background:white;border-radius:20px;padding:40px;max-width:600px;margin:0 auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);'><h1 style='color:#4CAF50;'>×§×•×“ ×”××§×•×¨ ××•×›×Ÿ! ğŸ‘¨â€ğŸ’»</h1><p style='font-size:18px;'>×§×•×“ ×”××§×•×¨ ×©×œ <b>${APP_NAME}</b> × ××¨×– ×•××•×›×Ÿ ×œ×¤×™×ª×•×—.</p><br><a href='$DOWNLOAD_URL' style='background:#4CAF50;color:white;padding:15px 30px;text-decoration:none;border-radius:50px;font-weight:bold;font-size:18px;'>×”×•×¨×“ ZIP</a><br><br><p style='color:#666;font-size:12px;'>× ×‘× ×” ×‘×××¦×¢×•×ª Web2App Builder</p></div></body></html>"
          
          EMAIL_HTML_ESCAPED=$(echo "$EMAIL_HTML" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\n')
          
          curl -s -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d "{\"from\":\"Web2App <onboarding@resend.dev>\",\"to\":[\"${{ github.event.client_payload.notification_email }}\"],\"subject\":\"ğŸ‘¨â€ğŸ’» ×§×•×“ ×”××§×•×¨ ×©×œ×š ××•×›×Ÿ!\",\"html\":\"${EMAIL_HTML_ESCAPED}\"}"
