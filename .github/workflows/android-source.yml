name: Package Android Source Code

on:
  repository_dispatch:
    types: [package-source]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      # ==========================================
      # 1. ×”×ª×—×œ×” ××”×™×¨×”
      # ==========================================
      - name: 5% - Initial Notification
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"android_source_status\": \"processing\", \"source_progress\": 5, \"source_message\": \"Initializing source packager...\"}"

      - name: Checkout
        uses: actions/checkout@v4

      # ==========================================
      # 2. ×¢×™×‘×•×“ × ×›×¡×™×
      # ==========================================
      - name: 30% - Install Tools & Prepare Assets
        run: |
          sudo apt-get update > /dev/null && sudo apt-get install -y imagemagick zip > /dev/null
          
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 30, \"source_message\": \"Processing icons and assets...\"}"

          mkdir -p android/app/src/main/res/mipmap-mdpi android/app/src/main/res/mipmap-hdpi android/app/src/main/res/mipmap-xhdpi android/app/src/main/res/mipmap-xxhdpi android/app/src/main/res/mipmap-xxxhdpi
          
          curl -s -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png

      # ==========================================
      # 3. ×”×–×¨×§×ª ×§×•× ×¤×™×’×•×¨×¦×™×”
      # ==========================================
      - name: 60% - Inject Configuration
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 60, \"source_message\": \"Writing configuration files...\"}"
          
          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primary_color }}';
            static const String themeMode = '${{ github.event.client_payload.config.theme_mode }}';
            static const String orientation = '${{ github.event.client_payload.config.orientation }}';
            static const bool showNavigation = ${{ github.event.client_payload.config.navigation }};
            static const bool pullToRefresh = ${{ github.event.client_payload.config.pull_to_refresh }};
            static const bool splashScreen = ${{ github.event.client_payload.config.splash_screen }};
            static const bool enableZoom = ${{ github.event.client_payload.config.enable_zoom }};
            static const bool keepAwake = ${{ github.event.client_payload.config.keep_awake }};
            static const bool openExternalLinks = ${{ github.event.client_payload.config.open_external_links }};
            static const String privacyPolicyUrl = '${{ github.event.client_payload.config.privacy_policy_url }}';
            static const String termsUrl = '${{ github.event.client_payload.config.terms_url }}';
          }
          EOF
          
          cat > README_FIRST.txt << EOF
          # Android Source Code - ${{ github.event.client_payload.name }}
          Generated by Web2App Builder.
          EOF

      # ==========================================
      # 4. ×›×™×•×•×¥ ×•×”×¢×œ××”
      # ==========================================
      - name: 80% - Zip Source
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 80, \"source_message\": \"Compressing source code...\"}"
          
          zip -r source_code.zip . -x ".git/*" ".github/*" "build/*" ".dart_tool/*" ".idea/*" "**/*.iml" "android/.gradle/*"

      - name: 95% - Upload to Storage
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          curl -s -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/source-code/${APP_ID}.zip" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "x-upsert: true" \
            -H "Content-Type: application/zip" \
            --data-binary @source_code.zip

      # ==========================================
      # 5. ×¡×™×•× ×•××™×™×œ ×¤×¨×™××™×•×
      # ==========================================
      - name: 100% - Update DB & Email
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          APP_NAME="${{ github.event.client_payload.name }}"
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/source-code/${APP_ID}.zip"
          PRIMARY_COLOR="${{ github.event.client_payload.config.primary_color }}"
          [ -z "$PRIMARY_COLOR" ] && PRIMARY_COLOR="#2196F3"
          ICON_URL="${{ github.event.client_payload.icon_url }}"
          
          # ×¢×“×›×•×Ÿ DB ×¡×•×¤×™
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${APP_ID}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"android_source_status\": \"completed\", \"source_progress\": 100, \"source_url\": \"${DOWNLOAD_URL}\", \"source_message\": \"Source code ready!\"}"

          # ×™×¦×™×¨×ª ××™×™×œ HTML ××•×©×§×¢ ×•××§×¦×•×¢×™ ×œ××¤×ª×—×™×
          EMAIL_HTML="<!DOCTYPE html><html dir='rtl'><head><meta charset='UTF-8'></head><body style='margin:0;padding:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);'><div style='max-width:650px;margin:40px auto;padding:0 20px;'><div style='text-align:center;margin-bottom:24px;'><img src='https://res.cloudinary.com/ddsogd7hv/image/upload/v1770576910/Icon2_dvenip.png' style='width:80px;height:80px;border-radius:20px;box-shadow:0 8px 24px rgba(0,0,0,0.2);'/><div style='margin-top:12px;'><a href='https://web2app-builder.vercel.app/' style='color:white;text-decoration:none;font-size:24px;font-weight:700;'>Web2App Builder</a></div></div><div style='background:white;border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);'><div style='background:${PRIMARY_COLOR};padding:48px 32px;text-align:center;'><div style='font-size:64px;margin-bottom:16px;'>ğŸ’»</div><h1 style='margin:0;color:white;font-size:28px;'>×§×•×“ ×”××§×•×¨ ××•×›×Ÿ! ğŸš€</h1><p style='margin:16px 0 0;color:rgba(255,255,255,0.95);'>×”×§×‘×¦×™× × ××¨×–×• ×•××•×›× ×™× ×œ×¤×™×ª×•×—</p></div><div style='padding:40px 32px;'><div style='text-align:center;margin-bottom:32px;'><img src='${ICON_URL}' style='width:100px;height:100px;border-radius:24px;box-shadow:0 8px 24px rgba(0,0,0,0.15);margin-bottom:16px;'/><h2 style='margin:0;color:#1a1a1a;font-size:24px;'>${{ github.event.client_payload.name }}</h2><p style='margin:8px 0 0;color:#666;font-size:14px;'>Source Code Package (ZIP)</p></div><div style='background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);border-radius:16px;padding:24px;margin-bottom:32px;'><table style='width:100%;'><tr><td style='padding:14px 0;border-bottom:1px solid rgba(0,0,0,0.06);'><span style='font-size:20px;margin-left:12px;'>ğŸ“¦</span><span style='color:#666;font-size:14px;'>Package Name</span></td><td style='padding:14px 0;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left;'><code style='background:white;padding:6px 12px;border-radius:6px;font-size:13px;'>${{ github.event.client_payload.package_name }}</code></td></tr></table></div><div style='text-align:center;margin:40px 0;'><a href='${DOWNLOAD_URL}' style='display:inline-block;background:${PRIMARY_COLOR};color:white;text-decoration:none;padding:18px 56px;border-radius:50px;font-size:18px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,0.2);'>â¬‡ï¸ ×”×•×¨×“ ×§×•×“ ××§×•×¨ (ZIP)</a></div><div style='background:#e3f2fd;border-radius:16px;padding:28px;border-left:4px solid #2196F3;'><h3 style='margin:0 0 16px;color:#0d47a1;font-size:18px;'>ğŸ› ï¸ ×”×•×¨××•×ª ×œ××¤×ª×—×™×</h3><ol style='margin:0;padding-right:24px;color:#0d47a1;font-size:15px;line-height:2;'><li>×—×œ×¥ ××ª ×§×•×‘×¥ ×”-ZIP</li><li>×¤×ª×— ×‘-Android Studio ××• VS Code</li><li>×”×¨×¥ ×‘×˜×¨××™× ×œ: <code>flutter pub get</code></li><li>×”×ª×—×œ ×œ×¤×ª×—!</li></ol></div></div><div style='background:linear-gradient(135deg,#2d3748 0%,#1a202c 100%);padding:32px;text-align:center;'><p style='margin:0 0 8px;color:white;font-size:16px;'>× ×‘× ×” ×‘-<b>Web2App Builder</b></p><p style='margin:0;color:rgba(255,255,255,0.6);font-size:13px;'>×”×¤×•×š ×›×œ ××ª×¨ ×œ××¤×œ×™×§×¦×™×” ××§×¦×•×¢×™×ª</p></div></div></div></body></html>"
          
          EMAIL_HTML_ESCAPED=$(echo "$EMAIL_HTML" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr -d '\n')
          
          curl -s -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d "{\"from\":\"Web2App <onboarding@resend.dev>\",\"to\":[\"${{ github.event.client_payload.notification_email }}\"],\"subject\":\"ğŸ’» ×§×•×“ ×”××§×•×¨ ×©×œ×š ××•×›×Ÿ! (${APP_NAME})\",\"html\":\"${EMAIL_HTML_ESCAPED}\"}"
