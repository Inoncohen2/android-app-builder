name: Package Android Source Code

on:
  repository_dispatch:
    types: [package-source]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: 5% - Booting Build Server
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_status\": \"processing\", \"source_progress\": 5, \"build_message\": \"Initializing dedicated build server...\"}"

      - name: Checkout Source
        uses: actions/checkout@v4

      - name: 15% - Repository Ready
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 15, \"build_message\": \"Fetching latest project source code...\"}"

      - name: 30% - Preparing Tools
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 30, \"build_message\": \"Installing graphic & compression tools...\"}"
          sudo apt-get update > /dev/null && sudo apt-get install -y imagemagick zip > /dev/null

      - name: 45% - Branding & Iconography
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 45, \"build_message\": \"Generating application icons and assets...\"}"
          
          # 爪专转 拽
          mkdir -p android/app/src/main/res/mipmap-mdpi android/app/src/main/res/mipmap-hdpi android/app/src/main/res/mipmap-xhdpi android/app/src/main/res/mipmap-xxhdpi android/app/src/main/res/mipmap-xxxhdpi
          curl -s -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png

      - name: 60% - Injecting Config
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 60, \"build_message\": \"Injecting user configuration into lib/app_config.dart...\"}"
          
          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primary_color }}';
          }
          EOF

      - name: 75% - Final Packaging
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 75, \"build_message\": \"Filtering build files and creating ZIP archive...\"}"
          
          # 爪专转 README 注
          echo "Source code for ${{ github.event.client_payload.name }} ready for development." > README_FIRST.txt
          
          # 专 拽爪注转
          zip -r source_code.zip . -x ".git/*" ".github/*" "build/*" ".dart_tool/*" ".idea/*"

      - name: 90% - Storage Transfer
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_progress\": 90, \"build_message\": \"Uploading package to secure cloud storage...\"}"
          
          curl -s -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/source-code/${{ github.event.client_payload.app_id }}.zip" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "x-upsert: true" \
            --data-binary @source_code.zip

      - name: 100% - Success & Email Notification
        run: |
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/source-code/${{ github.event.client_payload.app_id }}.zip"
          APP_NAME="${{ github.event.client_payload.name }}"
          
          # 注 住驻 -Supabase
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"source_status\": \"completed\", \"source_progress\": 100, \"source_url\": \"${DOWNLOAD_URL}\", \"build_message\": \"Your source code is ready!\"}"

          # 砖转  (Resend)
          curl -s -X POST 'https://api.resend.com/emails' \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d "{\"from\":\"Web2App <onboarding@resend.dev>\",\"to\":[\"${{ github.event.client_payload.notification_email }}\"],\"subject\":\" 拽 拽专 砖 !\",\"html\":\"<div dir='rtl'><h2>!</h2><p>拽 拽专 砖 <b>$APP_NAME</b>  注转 专.</p><br><a href='$DOWNLOAD_URL' style='padding:10px;background:#2563eb;color:white;text-decoration:none;border-radius:5px;'>专 拽 拽专 (ZIP)</a></div>\"}"
