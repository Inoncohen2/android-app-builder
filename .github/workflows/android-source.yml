name: Package Android Source Code

on:
  repository_dispatch:
    types: [package-source]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - name: Initial Notification
        run: |
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${{ github.event.client_payload.app_id }}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"progress\": 5, \"build_message\": \"Preparing professional source package...\"}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y imagemagick zip

      - name: Generate Assets & Config
        run: |
          # יצירת האייקונים בתיקיות ה-Android
          mkdir -p android/app/src/main/res/mipmap-mdpi android/app/src/main/res/mipmap-hdpi android/app/src/main/res/mipmap-xhdpi android/app/src/main/res/mipmap-xxhdpi android/app/src/main/res/mipmap-xxxhdpi
          curl -s -L -o /tmp/icon.png "${{ github.event.client_payload.icon_url }}"
          convert /tmp/icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert /tmp/icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert /tmp/icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png

          # הזרקת הקונפיגורציה
          CLEAN_URL=$(echo "${{ github.event.client_payload.website_url }}" | sed 's/__//g' | xargs)
          cat > lib/app_config.dart << EOF
          class AppConfig {
            static const String appName = '${{ github.event.client_payload.name }}';
            static const String websiteUrl = '${CLEAN_URL}';
            static const String packageName = '${{ github.event.client_payload.package_name }}';
            static const String primaryColor = '${{ github.event.client_payload.config.primary_color }}';
            static const String themeMode = '${{ github.event.client_payload.config.theme_mode }}';
            static const String orientation = '${{ github.event.client_payload.config.orientation }}';
            static const bool showNavigation = ${{ github.event.client_payload.config.navigation }};
            static const bool pullToRefresh = ${{ github.event.client_payload.config.pull_to_refresh }};
            static const bool splashScreen = ${{ github.event.client_payload.config.splash_screen }};
            static const bool enableZoom = ${{ github.event.client_payload.config.enable_zoom }};
            static const bool keepAwake = ${{ github.event.client_payload.config.keep_awake }};
            static const bool openExternalLinks = ${{ github.event.client_payload.config.open_external_links }};
            static const String privacyPolicyUrl = '${{ github.event.client_payload.config.privacy_policy_url }}';
            static const String termsUrl = '${{ github.event.client_payload.config.terms_url }}';
          }
          EOF

      - name: Create Standard .gitignore
        run: |
          cat > .gitignore << EOF
          # Flutter/Dart
          .dart_tool/
          .packages
          .pub-cache/
          .pub/
          build/

          # Android
          android/**/generated/
          android/gen/
          android/local.properties
          android/app/src/main/res/mipmap-*
          .gradle/
          capture.png

          # IDEs
          .idea/
          .vscode/
          *.iml
          *.ipr
          *.iws

          # OS files
          .DS_Store
          Thumbs.db
          EOF

      - name: Create README Instruction
        run: |
          cat > README_FIRST.txt << EOF
          # Web2App Source Code - ${{ github.event.client_payload.name }}

          This package contains the full Flutter source code for your application.

          ## Prerequisites
          - Flutter SDK installed (https://docs.flutter.dev/get-started/install)
          - Android Studio or VS Code with Flutter extension.

          ## Quick Start
          1. Extract this ZIP file.
          2. Open the folder in your IDE.
          3. Run 'flutter pub get' to install dependencies.
          EOF

      - name: Zip Clean Source
        run: |
          # סינון קפדני למניעת שגיאות תחביר או קבצים מיותרים ב-Zip
          zip -r source_code.zip . \
            -x ".git/*" ".github/*" "build/*" ".dart_tool/*" ".idea/*" "**/*.iml" "android/.gradle/*"

      - name: Upload & Update Supabase
        run: |
          APP_ID="${{ github.event.client_payload.app_id }}"
          curl -s -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/source-code/${APP_ID}.zip" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "x-upsert: true" \
            -H "Content-Type: application/zip" \
            --data-binary @source_code.zip
          
          DOWNLOAD_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/source-code/${APP_ID}.zip"
          
          curl -s -X PATCH "${{ secrets.SUPABASE_URL }}/rest/v1/apps?app_id=eq.${APP_ID}" \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"status\": \"completed\", \"progress\": 100, \"source_url\": \"${DOWNLOAD_URL}\"}"
